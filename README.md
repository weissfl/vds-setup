# Базовая настройка VDS

Чеклист для начальной настройки свежего VDS на Ubuntu/Debian.

---

## 1. Обновление системы и применение security-патчей

Сразу после развёртывания нужно синхронизировать пакеты с репозиториями, поставить все обновления и перезагрузиться, чтобы применилось новое ядро и службы.

```bash
apt update && apt upgrade -y
apt autoremove -y
reboot
```

---

## 2. Настройка времени системы

Корректное время важно для логов, работы Fail2Ban и других сервисов, завязанных на тайминги.

Устанавливает часовой пояс (пример — Вьетнам):
```bash
timedatectl set-timezone Asia/Ho_Chi_Minh
```

Показывает текущее состояние времени и таймзоны:
```bash
timedatectl status
```

---

## 3. Установка базовых утилит и компонентов безопасности

Минимальный набор пакетов для работы с сетью и репозиториями, базового firewall, защиты от брутфорса, git и механизма автоматических обновлений безопасности.

```bash
apt install -y curl wget ufw fail2ban ca-certificates gnupg git unattended-upgrades
```

---

## 4. Создание пользователя с sudo-правами

Работать под отдельным пользователем безопаснее, чем под root. Пользователь добавляется в группу `sudo` для выполнения административных команд.

```bash
adduser <user_name>
usermod -aG sudo <user_name>
```

Краткий тест прав нового пользователя — временный вход, проверка sudo и возврат обратно в root:
```bash
su - <user_name>
sudo whoami
exit
```

---

## 5. Генерация SSH-ключа на локальном компьютере (Windows PowerShell)

SSH-ключ используется для входа на сервер без пароля. Создаётся один раз и хранится в папке `.ssh` пользователя.

Создание новой пары ключей (`Enter` на всех шагах — путь по умолчанию):
```powershell
ssh-keygen -t ed25519 -C "my_vds_key"
```

Показать публичный ключ, который нужно скопировать:
```powershell
type $env:USERPROFILE\.ssh\id_ed25519.pub
```

---

## 6. Добавление SSH-ключа для пользователя `<user_name>`

Обычно выполняется из-под `root`, чтобы сразу назначить правильные права и владельца файлов.

Создаёт директорию `.ssh` (если её нет):
```bash
mkdir -p /home/<user_name>/.ssh
```

Открывает файл `authorized_keys`. Нужно вставить туда скопированный публичный SSH-ключ одной строкой, сохранить файл (`Ctrl+O`, `Enter`) и выйти (`Ctrl+X`):
```bash
nano /home/<user_name>/.ssh/authorized_keys
```

Ограничивает доступ к папке `.ssh` только владельцу:
```bash
chmod 700 /home/<user_name>/.ssh
```

Закрывает доступ к файлу ключей для других пользователей:
```bash
chmod 600 /home/<user_name>/.ssh/authorized_keys
```

Назначает владельцем файлов пользователя `<user_name>`:
```bash
chown -R <user_name>:<user_name> /home/<user_name>/.ssh
```

---

## 7. Смена порта SSH

Стандартный порт 22 чаще сканируется ботами, поэтому его меняют на произвольный, чтобы снизить количество автоматических атак.

Открывает конфигурацию SSH-сервера:
```bash
nano /etc/ssh/sshd_config
```

Меняет порт SSH (пример — `2294`, можно указать любой свободный порт). Внизу файла найдите строку `#Port 22`, удалите `#` и измените 22 на нужный порт. Если такой строки нет — добавьте в конец файла:
```
Port 2294
```

Сохранить изменения (`Ctrl+O`, `Enter`) и выйти (`Ctrl+X`).

Проверяет конфигурацию на ошибки:
```bash
sshd -t
```

Перезапускает SSH-службу с новым портом:
```bash
systemctl restart ssh
```

---

## 8. Усиление безопасности SSH

⚠️ **ВАЖНО:** Перед выполнением этих шагов убедитесь, что можете зайти под новым пользователем по SSH-ключу. Оставьте одну root-сессию открытой для отката изменений при необходимости.

Открывает конфигурационный файл SSH-сервера:
```bash
nano /etc/ssh/sshd_config
```

Параметры управления доступом к SSH (запрет root-входа и паролей); строки нужно изменить или добавить в конец файла:
```
PermitRootLogin no
PasswordAuthentication no
```

Сохранить изменения (`Ctrl+O`, `Enter`) и выйти (`Ctrl+X`).

Проверяет конфигурацию SSH на ошибки перед применением:
```bash
sshd -t
```

Перезапускает SSH-службу с новыми настройками:
```bash
systemctl restart ssh
```

Проверка входа под новым пользователем в отдельном терминале (не закрывая текущую сессию):
```bash
ssh -p 2294 <user_name>@IP_СЕРВЕРА
```

---

## 9. Создание swap-файла 1GB

Swap используется как резерв памяти при нехватке RAM и помогает избежать падений процессов при пиковых нагрузках.

Создаёт swap-файл размером 1GB:
```bash
dd if=/dev/zero of=/swapfile bs=1M count=1024
```

Закрывает доступ к файлу для других пользователей:
```bash
chmod 600 /swapfile
```

Размечает файл как swap:
```bash
mkswap /swapfile
```

Активирует swap сразу без перезагрузки:
```bash
swapon /swapfile
```

Добавляет автоподключение swap после перезагрузки:
```bash
echo '/swapfile none swap sw 0 0' >> /etc/fstab
```

Показывает текущую оперативную память и подключённый swap, чтобы убедиться, что файл активирован:
```bash
free -h
```

---

## 10. Базовая настройка UFW (firewall)

По умолчанию запрещаются все входящие подключения и разрешается доступ по SSH, чтобы не потерять доступ к серверу.

Запрещает все входящие соединения:
```bash
ufw default deny incoming
```

Разрешает исходящие соединения:
```bash
ufw default allow outgoing
```

Разрешает доступ по SSH:
```bash
ufw allow 2294/tcp
```

Включает firewall:
```bash
ufw enable
```

Показывает текущий статус и правила:
```bash
ufw status verbose
```

---

## 11. Включение защиты Fail2Ban

Fail2Ban отслеживает попытки брутфорса и автоматически блокирует подозрительные IP; в конфигурации явно указывается кастомный SSH-порт.

Создаёт локальный файл конфигурации Fail2Ban:
```bash
nano /etc/fail2ban/jail.local
```

Добавляет настройки для защиты SSH с указанием нового порта (вставьте текст, затем сохраните `Ctrl+O`, `Enter` и выйдите `Ctrl+X`):
```ini
[sshd]
enabled = true
port = 2294
```

Добавляет сервис в автозапуск и запускает его сразу:
```bash
systemctl enable --now fail2ban
```

Показывает текущий статус работы сервиса без постраничного вывода:
```bash
systemctl status fail2ban --no-pager
```

---

## 12. Включение автоматических обновлений безопасности

Unattended-upgrades автоматически устанавливает security-обновления системы без ручного вмешательства.

Запускает интерактивную настройку и активацию автоматических обновлений:
```bash
dpkg-reconfigure --priority=low unattended-upgrades
```

Показывает текущую конфигурацию unattended-upgrades:
```bash
apt-config dump | grep Unattended
```

---

## 13. Проверка состояния сервисов

```bash
systemctl --failed
```

---

## Ссылки

- [OpenSSH documentation](https://www.openssh.com/manual.html)
- [UFW documentation](https://help.ubuntu.com/community/UFW)
- [Fail2Ban documentation](https://www.fail2ban.org/wiki/index.php/Main_Page)
